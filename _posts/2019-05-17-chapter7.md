---
layout: post
title:  "chapter 7"
date:   2019-05-17
image:
comments: true
---
Chapter 7 
====================================
안드로이드 바인더 IPC
---------------------------
> 바인더는 원래 IPC(Inter Process Comminucation) 도구이지만 안드로이드에서는 다른 프로세스에 있는 함수를 마치 현재 프로세스에 존재하는 함수처럼 사용할 수 있게 해주는 RPC(Remote Procedure Call)을 지원하는 데 주로 이용된다.

#### 7.1 리눅스 메모리 공간과 바인더 드라이버
>  안드로이드의 프로세스는 리눅스와 마찬가지로 4GB에 달하는 가상 주소 공간에서 실행된다. 이때 3GB의 사용자 공간과 1GB의 커널 공간으로 나뉜다.
> 사용자 코드와 관련 라이브러리는 사용자 공간의 코드 영역, 데이터 영역, 스택 영역에서 동작하고, 커널 공간에서 동작해야 할 코드는 커널 공간의 각 영역에서 동작한다. 프로세스는 독립적인 사용자 공간을 가지지만 커널 공간은 공유하기 때문에 서로 데이터의 교환이 가능하다.
> 안드로이드는 단순히 메세지를 전달하는 IPC개념이 아니라 상대방 프로세스에 존재하는 함수까지 호출할 수 있는 바인더라는 IPC도구를 채택해 프로세스 간의 RPC를 지원한다.
> ![image](https://user-images.githubusercontent.com/38609712/57878336-c5a4ab00-7854-11e9-9e37-f02c024d3561.png)
> 안드로이드에서 바인더를 통해 프로세스 간 통신을 수행하는 이유
> - 데이터의 신뢰성 확보
> - IPC간의 보안 문제 해결

#### 7.2 안드로이드 바인더 모델
> ![image](https://user-images.githubusercontent.com/38609712/57878572-46fc3d80-7855-11e9-83dc-5cda34bfbd89.png)
> 서비스 클라이언트가 바인더를 통해 서비스 서버의 FOO()함수를 호출한다.
> 바인더는 프로세스 간 통신의 중재자 역할을 하는 것이다. 바인더 IPC데이터는 상대편 프로세스의 함수 호출 정보들을 의미하며, 바인더 드라이버가 수행하는 IPC의 데이터 단위가 된다.
> IPC 데이터는 사용하고자 하는 서비스에 해당하는 번호와 호출할 함수명,바인더 프로토콜로 구성된다.
> - 서비스 번호: 안드로이드에서 동작중인 여러 서비스를 구분하기 위함
> - 함수명 : 서비스 서버에서 동작하는 여러 서비스 가운데 서비스 클라이언트가 호출할 함수를 찾기 위한 것
> - 바인더 프로토콜 : 바인더 드라이버와 프로세스 간의 IPC데이터를 처리하는 규약.
>
> 이러한 구성요소는 IPC데이터의 각 변수로 저장된다.

#### 7.2.1 바인더 IPC 데이터의 전달
> 바인더 드라이버는 문자 디바이스 드라이버처럼 open() 이나 ioctl()와 같은 시스템 콜을 통해 접근 가능하다.
> RPC를 시도하는 어플리케이션은 open() 시스템 콜을 통해 바인더 드라이버의 파일 디스크립터를 얻는다.
> 그리고 mmap() 시스템 콜을 통해 커널 내에서 IPC 데이터를 수신하기 위한 공유 공간을 확보한다.
> ioctl() 함수의 인자로 바인더 드라이버에 IPC 데이터를 전달한다.

#### 7.2.2 바인더 IPC 데이터의 흐름
>![image](https://user-images.githubusercontent.com/38609712/57881092-5b433900-785b-11e9-9261-95fb29efec5f.png)
> 안드로이드는 서비스 클라이언트가 서비스를 사용하기 위한 몇 가지 추상 계층을 제공한다.
> - 서비스 계층 : 특정 기능을 수행하는 서비스의 함수가 존재하는 계층이다.서비스 클라이언트는 이 계층에서 사용하고자 하는 서비스의 함수를 가상으로 호출하고, 서비스 서버는 서비스 클라이언트가 요청한 서비스의 함수를 실제로 호출한다.
> - RPC 계층 : 서비스 클라이언트는 이 계층에서 서비스의 함수를 호출하기 위한 RPC코드와 RPC 데이터를 생성한다. 서비스 서버는 전달받은 Rpc 코드를 토대로 함수를 찾고 RPC 데이터를 전달한다.
> - IPC 계층 : RPC 계층에서 만든 RPC 코드와 RPC 데이터를 바인더 드라이버에 전달하기 위한 바인더 IPC 데이터로 캡슐화하는 역할을 한다.
> - 바인더 드라이버 계층 : IPC 계층으로부터 전달받은 바인더 IPC 데이터를 통해 서비스를 가진 서비스 서버를 찾은 후 IPC 데이터를 전달한다.

#### 7.2.3 바인더 프로토콜

> 바인더 프로토콜은 바인더 IPC 데이터에 포함되어 IPC 계층에서 바인더 드라이버로 전달되거나 바인더 드라이버에서 IPC 계층으로 전달된다. 바인더 프로토콜은 전달 방향에 따라 두가지로 분류된다.
> - BINDER COMMAND PROTOCOL : 바인더 프로토콜이 IPC 계층 -> 바인더 드라이버 : 접두사로 BC_
> - BINDER RETURN PROTOCOL : 바인더 드라이버 -> IPC 계층 : 접두사로 BR_
> 바인더 프로토콜은 데이터를 송신하는 측과 수신하는 측에서 모두 알고 있는 규약이다. 따라서 프로세스와 바인더 드라이버는 헤더 파일에 바인더 프로토콜을 정의하고 있다.
> ![image](https://user-images.githubusercontent.com/38609712/57881565-985bfb00-785c-11e9-8491-dafc6010d150.png)
> - 서비스 클라이언트는 BC_TRANSACTION 프로토콜을 통해 바인더 드라이버에 IPC 데이터 전달을 명령
> - 바인더 드라이버는 전달받은 IPC 데이터를 토대로 바인더 프로토콜이 BC_TRANSACTION 이면 IPC 데이터의 핸들을 통해 서비스 서버를 찾는다.
> - 바인더 드라이버는 프로토콜을 변경하고 이를 IPC 데이터에 실어서 서비스 서버에 전달한다.
> - 서비스 서버는 전달받은 바인더 프로토콜을 체크한 후 IPC 데이터를 분석해서 서비스 사용자가 요청한 함수를 호출한다.

#### 7.2.4 RPC코드와 RPC 데이터
> ![image](https://user-images.githubusercontent.com/38609712/57881784-22a45f00-785d-11e9-8858-348f04fb4c86.png)
> - 서비스 클라이언트는 서비스 서버에 존재하는 서비스의 함수를 사용하기 위해 각 함수에 해당하는 식별자를 바인더 IPC 데이터에 담아 전달하는데, 이를 RPC코드라고 한다.
> 그리고 함수의 인자로 IPC 데이터에 담아 전달하는데 이것은 RPC데이터라고한다.

#### 7.2.5 바인더 어드레싱
> 안드로이드에는 서비스 목록을 관리하는 컨텍스트 매니저라는 프로세스가 있다. 이것은 서비스마다 핸들이라는 번호 값을 할당하고, 서비스의 추가/검색 등의 관리 기능을 수행한다.
> 바인더 드라이버는 IPC 데이터의 핸들을 가지고 서비스 서버를 찾는 데, 이러한 과정을 바인더 어드레싱이라고 한다. 바인더 어드레싱을 위해서 먼저 서비스 서버는 자신이 가진 서비스에 대한 접근 정보를 컨텍스트 매니저에 등록해야 한다.
> 
> ![image](https://user-images.githubusercontent.com/38609712/57882271-43b97f80-785e-11e9-816a-13f4dfd4541c.png)
> 서비스 등록 과정은 안드로이드 부팅 단계에서 끝난다. 서비스 등록이 끝나면 그림과 같이 서비스 목록,바인더 노드,서비스가 연결된다. 따라서 등록된 서비스는 다른 프로세스가 사용가능한 상태가 된다.
> 
> ![image](https://user-images.githubusercontent.com/38609712/57882374-7ebbb300-785e-11e9-9446-543b0c6883e5.png)
> 
> - 서비스 클라이언트가 서비스를 검색하는 과정
> - Get_SERVICE라는 RPC 코드와 요청할 서비스 이름,IPC 데이터를 바인더 드라이버를 통해 컨텍스트 매니저에게 전달한다.
> - 컨텍스트 매니저는 서비스를 찾은 다음 이를 바인더 드라이버에 전달한다.
> - 바인더 드라이버는 참조 데이터를 찾는다.
> - 서비스 클라이언트 쪽에 참조 데이터를 생성해 컨텍스트 매니저의 참조 데이터가 가리키는 바인더 노드를 연결한다.
> - 바인더 드라이버는 생성한 참조 데이터를 생성된 순서대로 번호를 매겨 서비스 클라이언트에게 알려준다.
> - 서비스 클라이언트는 이 번호를 핸들로 지정하여 서비스 서버의 바인더 노드를 찾게 된다.
> - 서비스 클라이언트는 전달 받은 참조 데이터의 번호를 핸들에 저장ㅇ하고, 사용할 서비스의 함수에 해당하는 RPC 코드와 RPC 데이터를 IPC 데이터에 담아 서비스 서버로 전달하여 서비스 A가 가진 함수를 호출한다.
> 
> ![image](https://user-images.githubusercontent.com/38609712/57882936-e32b4200-785f-11e9-8b86-0467e500c6f1.png)
